<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>RiverBot μ‹¤μ‹κ°„ λ€μ‹λ³΄λ“</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
</head>
<body>
  <header>
    <h1>π RiverBot μ‹¤μ‹κ°„ μκ±° μƒνƒ</h1>
  </header>

  <main>
    <canvas id="gauge"></canvas>
    <div id="percent">0%</div>
    <div class="alert" id="alertBox"></div>
  </main>

  <footer>
    <p>Connected to <strong>damoa.io</strong> via WebSocket (wss://damoa.io:9002)</p>
  </footer>

  <script>
    // β… WebSocket MQTT μ—°κ²° μ„¤μ •
    const brokerUrl = 'wss://damoa.io:9002';
    const topic = 'riverbot/#';
    const clientID = "webclient_" + Math.floor(Math.random() * 10000);

    // κ²μ΄μ§€ μ„¤μ •
    const opts = {
      angle: 0.15,
      lineWidth: 0.3,
      radiusScale: 1,
      pointer: { length: 0.6, strokeWidth: 0.04, color: '#000' },
      colorStart: '#6FADCF',
      colorStop: '#8FC0DA',
      strokeColor: '#E0E0E0',
      generateGradient: true,
      highDpiSupport: true
    };
    const target = document.getElementById('gauge');
    const gauge = new Gauge(target).setOptions(opts);
    gauge.maxValue = 100;
    gauge.setMinValue(0);
    gauge.animationSpeed = 32;
    gauge.set(0);

    // MQTT ν΄λΌμ΄μ–ΈνΈ μ„¤μ •
    const client = new Paho.MQTT.Client("damoa.io", 9002, clientID);

    client.onConnectionLost = (response) => console.log("β μ—°κ²° λκΉ€:", response.errorMessage);
    client.onMessageArrived = (message) => {
      console.log("π“© μμ‹ :", message.payloadString);
      const data = JSON.parse(message.payloadString);

      if (data.collection !== undefined) {
        gauge.set(data.collection);
        document.getElementById("percent").innerText = data.collection.toFixed(1) + "%";
      }

      if (data.alert !== undefined) {
        document.getElementById("alertBox").innerText = data.alert;
      } else {
        document.getElementById("alertBox").innerText = "";
      }
    };

    client.connect({
      onSuccess: () => {
        console.log("β… damoa.io WebSocket μ—°κ²° μ„±κ³µ");
        client.subscribe(topic);
      },
      useSSL: false
    });
  </script>
</body>
</html>
