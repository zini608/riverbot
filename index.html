<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>RiverBot 대시보드</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h1>RiverBot 대시보드</h1>
  <div class="container">
    <div class="card">
      <h2>인식된 쓰레기</h2>
      <img src="ntr202309190020.680x.0.jpg" alt="Detected Trash">
      <p><b>현재 인식 중:</b> 플라스틱 병</p>
    </div>

    <div class="card">
      <h2>수거망 상태</h2>
      <div class="gauge">
        <div class="gauge-inner">
          <div id="fullness">0%</div>
          <p>현재 수거량</p>
        </div>
      </div>
      <div class="footer">
        <h3>YOLO 인식률</h3>
        <p id="yolo">98%</p>
      </div>
    </div>
  </div>

  <div id="alertBox" class="alert-box">⚠ 수거망이 85% 이상 찼습니다!</div>

  <script>
    // HiveMQ WebSocket 브로커로 연결
    const client = mqtt.connect("wss://broker.hivemq.com:8000/mqtt");
    const fullnessElem = document.getElementById("fullness");
    const gauge = document.querySelector(".gauge");
    const alertBox = document.getElementById("alertBox");

    client.on("connect", () => {
      console.log("✅ MQTT Connected to HiveMQ");
      client.subscribe("riverbot/bin");
      client.subscribe("riverbot/alert");
    });

    client.on("message", (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        if (topic === "riverbot/bin") {
          const val = parseFloat(data.collection || 0).toFixed(1);
          fullnessElem.innerText = `${val}%`;
          gauge.style.background = `conic-gradient(#4CAF50 ${val}%, #ddd 0)`;
        } else if (topic === "riverbot/alert") {
          alertBox.style.display = "block";
          setTimeout(() => { alertBox.style.display = "none"; }, 5000);
        }
      } catch (e) {
        console.error("❌ 데이터 파싱 오류:", e);
      }
    });

    client.on("error", err => console.error("MQTT 연결 실패:", err));
  </script>
</body>
</html>
