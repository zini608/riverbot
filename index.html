<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>RiverBot ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
</head>
<body>
  <header>
    <h1>ğŸŒŠ RiverBot ì‹¤ì‹œê°„ ìˆ˜ê±° ìƒíƒœ</h1>
  </header>

  <main>
    <canvas id="gauge"></canvas>
    <div id="percent">0%</div>
    <div id="alertBox"></div>
    <div id="status">ğŸ•“ ì—°ê²° ìƒíƒœ: <span id="conn">ì—°ê²° ì¤‘...</span></div>
  </main>

  <footer>
    <p>Connected via HiveMQ WebSocket (wss://broker.hivemq.com:8000)</p>
  </footer>

  <script>
    const broker = "broker.hivemq.com";
    const port = 8000;
    const topic = "riverbot/#";
    const clientId = "webClient_" + Math.floor(Math.random() * 10000);

    // ê²Œì´ì§€ ì„¤ì •
    const opts = {
      angle: 0.15,
      lineWidth: 0.3,
      radiusScale: 1,
      pointer: { length: 0.6, strokeWidth: 0.04, color: '#000' },
      colorStart: '#6FADCF',
      colorStop: '#8FC0DA',
      strokeColor: '#E0E0E0',
      generateGradient: true,
      highDpiSupport: true
    };
    const target = document.getElementById('gauge');
    const gauge = new Gauge(target).setOptions(opts);
    gauge.maxValue = 100;
    gauge.setMinValue(0);
    gauge.animationSpeed = 32;
    gauge.set(0);

    // MQTT ì„¤ì •
    const client = new Paho.MQTT.Client(broker, port, clientId);

    client.onConnectionLost = (response) => {
      document.getElementById("conn").innerText = "âŒ ì—°ê²° ëŠê¹€";
      console.log("ì—°ê²° ëŠê¹€:", response.errorMessage);
    };

    client.onMessageArrived = (message) => {
      console.log("ğŸ“© ìˆ˜ì‹ :", message.payloadString);
      try {
        const data = JSON.parse(message.payloadString);
        if (data.collection !== undefined) {
          gauge.set(data.collection);
          document.getElementById("percent").innerText = data.collection.toFixed(1) + "%";
        }
        if (data.alert !== undefined) {
          document.getElementById("alertBox").innerText = data.alert;
        } else {
          document.getElementById("alertBox").innerText = "";
        }
      } catch (e) {
        console.log("â— JSON íŒŒì‹± ì˜¤ë¥˜:", e);
      }
    };

    // ì—°ê²°
    client.connect({
      useSSL: false,
      onSuccess: () => {
        document.getElementById("conn").innerText = "âœ… ì—°ê²° ì„±ê³µ";
        console.log("âœ… HiveMQ ì—°ê²° ì„±ê³µ");
        client.subscribe(topic);
      },
      onFailure: (err) => {
        document.getElementById("conn").innerText = "âŒ ì—°ê²° ì‹¤íŒ¨";
        console.error("âŒ ì—°ê²° ì‹¤íŒ¨:", err.errorMessage);
      }
    });
  </script>
</body>
</html>

